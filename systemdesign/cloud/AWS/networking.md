
# VPC
![image](https://user-images.githubusercontent.com/466385/230110176-bb24d609-d711-4e3b-abe2-f285f32f03c4.png)
- https://aws.amazon.com/vpc/faqs/
- a logical contruct that overlays across all az's in a region
- a vpc can have subnets in multiple AZ's
- not restricted to single subnet per AZ.
- traffic between diff subnets in the same AZ is called intra-zone(not charged)
- traffic between diff subnets across AZ's is called inter-zone traffic.(chargeable)
- 1 VPC : m subnets : upto m x n instances
- When creating a VPC need to specify CIDR range (/16 | /28) for that VPC to use.
  - /16 gives 2^(32 -'16' - 2 => 65534 usable IPv4 IPs
  - /28 gives 2^(32 -'28' - 2 => 2 usable IPs.
  - RFC 1918 CIDR addrs preferred
    - 10.x.y.z/8 | 192.168.x.y/16 | 172.168.0.0/12
    - In each subnet we create in a VPC, AWS reserves 5 of those usable IPs.    
      - resvd addrs
      - +0: network address
      - +1: gateway
      - +2: DNS
      - +3: future use
      - +last: bcast not allowed
    - ![image](https://user-images.githubusercontent.com/466385/230108842-43cea789-bfbc-4f4d-ad4e-ea4771745632.png)
  - see CIDR cheatsheet at 
    - https://pbxbook.com/other/cidrcheat.html
    - https://www.freecodecamp.org/news/subnet-cheat-sheet-24-subnet-mask-30-26-27-29-and-other-ip-address-cidr-network-references/
  - IPv6 VPCs
    - All IPv6 addrs in AWS VPCs are in /56 subnet
    - No extra charge from AWS for allocation of Ipv6 addr
    - No distinction between public and pvt IPv6 addrs as there are no pvt IPv6 addrs
  - ENI : Elastic Network Interface
    - Can move ENI from one EC2 VM to another dynamically
    - An ENI needs to have one primary IP and can have multiple secondary IPs.
    - Read: [2011 article](https://aws.amazon.com/blogs/aws/new-elastic-network-interfaces-in-the-virtual-private-cloud/)
    - [Using ENIs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html)
   
  - Placement groups
    - ![image](https://user-images.githubusercontent.com/466385/230322408-87bbee1f-271e-4665-b322-0026e49dcb1f.png)
    - Placement groups types - Cluster|Partition|Spread
  - Public and Pvt Subnets
    - Route Tables: collection of tules of how to move traffic in / out of the VPC
    - Types of route tables : Main Route table| Custom Route Table | Gateway Table | Local Gateway
      - A Main route table is created each time you create a VPC
      - Custom route table/s
   - Routes
     - Route = Dest + Target + IPv(4|6) + Route Priority
       - Target is a next Hop. 0.0.0.0/0 is the most generic default route
       - Route selection: most specific route is always chosen. eg 10.0.0.0/24 more specific than 10.0.0.0/16
       - diff types of Targets | Next Hops:
         - Internet Gateway
         - Egress Only Internet Gateway
           - by default each VM gets pvt IPv4 and IPv6 addr
           - If a route exists in the VM to reach the internet, anyone knowng the VM IPv6 addr can reach it from outside
           - So AWS created the Egress Only Internet Gateway (Egress-Only IGW) that does not allow incoming reqs from outside
         - NAT Gateway
         - Outpost Local Gateway
         - Transit Gateway
         - Virtual Pvt Gateway
         - (NAT) Instance
         - Network Interface in the VPC : 
         - Peering Connection : to get from one VPC to another if it matches Dest CIDR range
       - Subnet types
         - All subnets send traffic to the dafult route which is the +1 addr. viz. a.b.c.1 or 10.x.y.1  
         - Public Subnet : where a route exists to the internet gateway
         - Pvt Subnet: where no route to the internet gateway exists   
      - Internet Gateway
        - is a highly available distributed service provided by AWS
        - Internet Gateway simply needs to be attached to a VPC to have interet routable traffic
        - Public IPs and Elastic IPs(public IPv4 address) actually sit out with the Internet Gateway
        - subnet -> router -> IGW - > Internet
      - Diff bet NAT Gateway and NAT Instance
        - NAT G/w
          - AWS provided Service + Highly Available per AZ
          - Bandwidth : 45Gbps per flow but not scalable
          - Managed by AWS
          - Charged by #gateways + duration + amt of data in transit
          - no Port fwding support
          - no Bastion Host support
          - No support for security groups
          - More commonly used option
        - NAT Instance
          - EC2 instance, needs user script for manual F/O 
          - Bandwidth dependent on instance type
          - Managed by user
          - Charged by #instances + duration + instance type|size
          - Can be lower cost option than NAT instance
          - Has Port fwding support
          - Has Bastion Host support: can connect instances on pbt subnet
          - Can associate + has support for security groups
   - Amazon DNS
     - enableDNSHostNames : DNS that gives public hostname to public IP addr
     - enableDNSSuport : determines whether internal DNS is enabled for the VPC
     - default VPC : both enableDNSHostNames + enableDNSSuport is True
     - custom VPC : only enableDNSSuport True
     - DNS Naming conventions
       - Amazon provided Pvt DNS naming conventions 
         - FOr an IP addr like 10.0.0.15
         - Only in us-east-1(orig region) : ip-10-0-0-15.ec2.internal.
         - Outside of us-east-1           : ip-10-0-0-15.region.compute.internal
       - Public DNS naming conventions
         - say 8.8.8.8 is given a DNS like 
           - us-east-1    : ec2-8-8-8-8.compute-1.amazonaws.com  
           - other regions: ec2-8-8-8-8.<region>.compute.amazonaws.com
     - DNS Pvt Hosted Zones
       - use AWS Route53 for their entries
       - ![image](https://user-images.githubusercontent.com/466385/230753933-7faf8343-eb21-4318-827e-ac9d6be47f9c.png)
     - ![image](https://user-images.githubusercontent.com/466385/230754067-b5302492-7290-4602-b57a-cfabac6422e7.png)
- Regional and VPC endpoints
  - provide secure access to AWS services
  - no public IP needed and traffic stays does not traverse public n/w
  - Types of VPC end-points
    - Gateway VPC end-point
      - Only for s3 and DynamoDB which are historical entities for g/w VPC endpoint
      - G/w endpoints use route tables
      - Service and gateway endpoints
      - One service per endpoint Gateway service:endpoint::1:1
      - One policy per endpoint 
      - One route per service
      - Multiple endpoints per VPC
      - Multiple endpoints per service
      - Gateway endpoint limitations
        - use a prefix list to determine dest for a route
        - ![image](https://user-images.githubusercontent.com/466385/232687164-fd836b48-c35a-47ee-a6d7-1503023a038e.png)
    - Interface VPC end-point
      - adds ifaces to subnets and then uses DNS to access service on that iface
      - AWS PrivateLink interface to link other services to a VPC
    - Flow Logs
      - can be set on VPC | Subnet | individual ifaces
      - destination for flow logs can be Cloudwatch | S3
- Hybrid Connectivity
- VPC peering: connection between 2 VPC's both IpV4 + IPv6 compat + multi account (prod<>test) + multi AZ connectivity
  - Usecases
    - connect vpc1 <> vpc2 and vpc2 <> vpc3 but transit connectivity bet VPCs not allowed.
    - vpc peering is 1:1 not a broadcast or mesh connection 
  - unsupported scenarios:overlapping CIDR overlap + transitive peering + edge-edge routing
  - peering process: request vpc connection + update route tables + update security groups(nested allowed) + enable DNS resolution 
- AWS Site-to-Site VPN options
  - two options: Virt Pvt Gateways vs EC2 gateway instances
  - ![image](https://user-images.githubusercontent.com/466385/232767011-efc1a4e3-ff25-409b-8220-26588512c094.png)
- Virtual Interface types
  - Public: access AWS services using public addrs
  - Pvt : access AWS services using pvt addrs
  - Transit : connect transit gateways with Direct Connect gateways
  - Hosted : access to other AWS accounts
- Direct Connect gateway
  - Globally avlabl resource used to connect one | more VPCs
  - Can attach transit | pvt virt ifaces to the Direct Connect
  - Can connect on the other side to either transit | Virt gateway thats attched to many VPCs
  - Support for many accounts + regions +  VPCs  
  - ![image](https://user-images.githubusercontent.com/466385/232773557-190da2d7-6078-404b-88e0-df933659d7b8.png)
  - Summary
    - ![image](https://user-images.githubusercontent.com/466385/232777648-91166974-a31f-4a9a-86b3-c242dc54c77e.png)

  

  
  

  
  

